#!/bin/bash
echo "-----> Installing dependencies"
apt-get update -qq && apt-get install -y -qq build-essential zlib1g-dev libpcre3 libpcre3-dev

echo "-----> Downloading and installing OpenSSL"
mkdir -p /app/openssl
curl -s https://www.openssl.org/source/openssl-3.0.8.tar.gz -o openssl-3.0.8.tar.gz
tar -xzf openssl-3.0.8.tar.gz -C /app/openssl --strip-components=1
cd /app/openssl
./config --prefix=/app/openssl --openssldir=/app/openssl
make -j$(nproc)
make install

echo "-----> Downloading and installing PCRE library"
mkdir -p /app/pcre
curl -sL https://sourceforge.net/projects/pcre/files/pcre/8.45/pcre-8.45.tar.gz/download -o pcre-8.45.tar.gz
tar -xzf pcre-8.45.tar.gz -C /app/pcre --strip-components=1
cd /app/pcre
./configure --prefix=/app/pcre
make -j$(nproc)
make install

echo "-----> Downloading and installing zlib"
mkdir -p /app/zlib
curl -sL http://zlib.net/zlib-1.2.13.tar.gz -o zlib-1.2.13.tar.gz
tar -xzf zlib-1.2.13.tar.gz -C /app/zlib --strip-components=1
cd /app/zlib
./configure --prefix=/app/zlib
make -j$(nproc)
make install

echo "-----> Installing nginx"
mkdir -p /app/nginx
curl -s https://nginx.org/download/nginx-1.25.3.tar.gz | tar -xz -C /app/nginx --strip-components=1
cd /app/nginx
./configure --prefix=/app/nginx --with-http_ssl_module --with-pcre=/app/pcre --with-openssl=/app/openssl --with-zlib=/app/zlib
make -j$(nproc)
make install
